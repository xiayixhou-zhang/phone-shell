<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>搜索</title>
    <style>
        :root { --bg: #f2f2f2; --blue: #576b95; --green: #07c160; --grey: #b2b2b2; --border: #e5e5e5; }
        body, html { margin: 0; padding: 0; background: var(--bg); font-family: -apple-system, sans-serif; height: 100%; overflow: hidden; }

        /* 视图管理：确保页面完全独立 */
        .page-container { position: relative; width: 100%; height: 100%; }
        .page { position: absolute; inset: 0; background: var(--bg); display: flex; flex-direction: column; z-index: 10; transition: transform 0.3s ease; }
        #calendarPage { z-index: 100; transform: translateX(100%); background: #fff; }
        #calendarPage.active { transform: translateX(0); }

        /* 顶部搜索框 */
        .header { background: #ededed; padding: 8px 15px; display: flex; align-items: center; gap: 12px; }
        .search-box { flex: 1; background: #fff; height: 36px; border-radius: 6px; display: flex; align-items: center; padding: 0 10px; }
        .search-box input { border: none; outline: none; width: 100%; font-size: 17px; background: transparent; }
        .cancel-btn { color: var(--blue); font-size: 17px; cursor: pointer; white-space: nowrap; }

        /* 快速搜索导航网格 */
        .nav-section { padding-top: 50px; text-align: center; }
        .nav-title { color: var(--grey); font-size: 14px; margin-bottom: 25px; }
        .nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px 0; }
        .nav-item { color: var(--blue); font-size: 16px; position: relative; cursor: pointer; }
        .nav-item:not(:nth-child(3n))::after { content: ""; position: absolute; right: 0; top: 15%; height: 70%; width: 1px; background: var(--border); }

        /* 搜索结果 */
        #resultsArea { flex: 1; overflow-y: auto; background: #fff; display: none; }
        .res-item { padding: 12px 15px; border-bottom: 0.5px solid var(--border); }
        .res-date { font-size: 12px; color: var(--grey); margin-bottom: 4px; }
        .hl { color: var(--green); font-weight: bold; }

        /* 日历页面样式 (图3/图7像素级还原) */
        .cal-nav { background: var(--bg); height: 44px; display: flex; align-items: center; padding: 0 15px; border-bottom: 0.5px solid var(--border); }
        .back-btn { font-size: 20px; width: 40px; cursor: pointer; }
        .cal-title { flex: 1; text-align: center; font-weight: 500; font-size: 17px; }
        .cal-month-head { padding: 15px; color: var(--grey); font-size: 14px; background: #fff; border-bottom: 0.5px solid var(--border); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; background: #fff; padding: 10px 5px; }
        .cal-grid div { padding: 15px 0; font-size: 18px; cursor: pointer; position: relative; transition: 0.2s; }
        .week-h { color: var(--grey); font-size: 12px !important; pointer-events: none; }
        .today-circle { background: var(--green); color: #fff; border-radius: 50%; width: 38px; height: 38px; line-height: 38px; margin: 0 auto; position: relative; top: -10px; }
        .today-label { font-size: 10px; color: var(--green); position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); }
        .disabled { color: #ccc !important; cursor: default !important; }
    </style>
</head>
<body>

<div class="page-container">
    <div id="mainPage" class="page">
        <div class="header">
            <div class="search-box">
                <input type="text" id="mainInput" placeholder="搜索" autofocus>
            </div>
            <div class="cancel-btn" onclick="history.back()">取消</div>
        </div>

        <div id="quickNav" class="nav-section">
            <div class="nav-title">快速搜索聊天内容</div>
            <div class="nav-grid">
                <div class="nav-item" onclick="openCalendar()">日期</div>
                <div class="nav-item" onclick="filterType('image')">图片与视频</div>
                <div class="nav-item" onclick="filterType('file')">文件</div>
                <div class="nav-item" onclick="filterType('link')">链接</div>
                <div class="nav-item">音乐与音频</div>
                <div class="nav-item">交易</div>
            </div>
        </div>

        <div id="resultsArea"></div>
    </div>

    <div id="calendarPage" class="page">
        <div class="cal-nav">
            <div class="back-btn" onclick="closeCalendar()">〈</div>
            <div class="cal-title">按日期查找</div>
        </div>
        <div class="cal-month-head">2026年2月 ∨</div>
        <div class="cal-grid" id="calendarGrid">
            <div class="week-h">日</div><div class="week-h">一</div><div class="week-h">二</div>
            <div class="week-h">三</div><div class="week-h">四</div><div class="week-h">五</div><div class="week-h">六</div>
            </div>
    </div>
</div>

<script>
    // 1. 获取数据（兼容多种可能的存储键名）
    const chatData = JSON.parse(localStorage.getItem('chat_history') || localStorage.getItem('temp_chat_log') || '[]');
    
    const mainInput = document.getElementById('mainInput');
    const quickNav = document.getElementById('quickNav');
    const resultsArea = document.getElementById('resultsArea');
    const calendarPage = document.getElementById('calendarPage');

    // 2. 搜索逻辑：输入关键词
    mainInput.addEventListener('input', (e) => {
        const val = e.target.value.trim().toLowerCase();
        if (val) {
            quickNav.style.display = 'none';
            resultsArea.style.display = 'block';
            const filtered = chatData.filter(m => m.content.toLowerCase().includes(val));
            render(filtered, val);
        } else {
            quickNav.style.display = 'block';
            resultsArea.style.display = 'none';
        }
    });

    // 3. 分类过滤逻辑 (图片/文件等)
    function filterType(type) {
        mainInput.value = (type === 'image' ? '正在查看图片' : '正在查看文件');
        quickNav.style.display = 'none';
        resultsArea.style.display = 'block';
        const filtered = chatData.filter(m => m.type === type);
        render(filtered);
    }

    // 4. 日历页面管理
    function openCalendar() { calendarPage.classList.add('active'); }
    function closeCalendar() { calendarPage.classList.remove('active'); }

    // 5. 按日期搜索逻辑
    function searchDate(dateStr) {
        closeCalendar();
        mainInput.value = dateStr;
        quickNav.style.display = 'none';
        resultsArea.style.display = 'block';
        // 匹配 2026-02-12 格式
        const filtered = chatData.filter(m => m.date === dateStr);
        render(filtered);
    }

    // 6. 渲染结果
    function render(data, keyword = "") {
        if (data.length === 0) {
            resultsArea.innerHTML = '<div style="text-align:center;padding:50px;color:#999;">无搜索结果</div>';
            return;
        }
        resultsArea.innerHTML = data.map(m => {
            let content = m.content;
            if (keyword && keyword.length < 10) { // 避免日期也被高亮
                content = content.split(keyword).join(`<span class="hl">${keyword}</span>`);
            }
            return `
                <div class="res-item">
                    <div class="res-date">${m.date || '未知日期'} ${m.time || ''}</div>
                    <div>${content}</div>
                </div>
            `;
        }).join('');
    }

    // 7. 初始化日历 (自动生成 2026年2月)
    function initCalendar() {
        const grid = document.getElementById('calendarGrid');
        const today = new Date();
        const todayDay = today.getDate(); // 12
        
        // 填充 2月1日前空的格子 (2026.2.1是周日，无需填空)
        for (let i = 1; i <= 28; i++) {
            const dateStr = `2026-02-${i < 10 ? '0'+i : i}`;
            const dayEl = document.createElement('div');
            
            if (i === todayDay) {
                dayEl.innerHTML = `<div class="today-circle">${i}</div><div class="today-label">今天</div>`;
            } else {
                dayEl.innerText = i;
                if (i > todayDay) dayEl.className = 'disabled';
            }

            if (i <= todayDay) {
                dayEl.onclick = () => searchDate(dateStr);
            }
            grid.appendChild(dayEl);
        }
    }

    initCalendar();
</script>

</body>
</html>
