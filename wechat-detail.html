<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>聊天详情</title>
  <style>
    body { margin: 0; background-color: #f1f1f1; font-family: -apple-system, sans-serif; }
    .nav-bar { position: sticky; top: 0; height: 44px; background: #ededed; display: flex; align-items: center; padding: 0 12px; border-bottom: 0.5px solid #d8d8d8; z-index: 100; }
    .back-btn { font-size: 22px; color: #000; text-decoration: none; padding-right: 15px; }
    .nav-title { font-size: 17px; font-weight: 500; flex: 1; text-align: center; margin-right: 30px; }
    
    .list-group { background: #fff; margin-bottom: 8px; }
    .list-item { position: relative; height: 56px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-size: 16px; color: #000; cursor: pointer; }
    .list-item::after { content: ""; position: absolute; bottom: 0; right: 0; left: 16px; height: 0.5px; background: #e5e5e5; }
    .list-item:last-child::after { display: none; }
    .arrow { color: #b2b2b2; margin-left: 8px; font-family: "SimSun"; font-weight: bold; }
    
    .section-title { padding: 10px 16px; font-size: 13px; color: #888; }
    #bg-input { display: none; }
  </style>
</head>
<body>

  <div class="nav-bar">
    <a href="wechat.html" class="back-btn">〈</a>
    <span class="nav-title">聊天详情</span>
  </div>

  <div class="section-title">记忆管理</div>
  <div class="list-group">
    <div class="list-item" onclick="searchChat()">
      <span>查找聊天内容</span>
      <span class="arrow">></span>
    </div>
    <div class="list-item" onclick="exportToMemory()">
      <span>同步到记忆库</span>
      <div class="item-right" style="color:#07C160; font-size:14px;">点击同步</div>
    </div>
    <div class="list-item" onclick="downloadChat()">
      <span>导出聊天记录 (.txt)</span>
      <span class="arrow">></span>
    </div>
  </div>

  <div class="section-title">外观设置</div>
  <div class="list-group">
    <div class="list-item" onclick="document.getElementById('bg-input').click()">
      <span>设置当前聊天背景</span>
      <span class="arrow">></span>
      <input type="file" id="bg-input" accept="image/*">
    </div>
  </div>

  <div class="list-group" style="margin-top:20px;">
    <div class="list-item" style="color:#fa5151; justify-content:center;" onclick="clearHistory()">清空并切分记录</div>
  </div>

  <script>
    // 1. 搜索
    function searchChat() {
      const keyword = prompt("输入关键词：");
      if (!keyword) return;
      const history = JSON.parse(localStorage.getItem('chat_history') || '[]');
      const results = history.filter(item => item.content.includes(keyword));
      alert(results.length > 0 ? `搜到 ${results.length} 条记录` : "无记录");
    }

    // 2. 同步到记忆库（存储到另一个 key 里供 memory.html 读取）
    function exportToMemory() {
      const history = localStorage.getItem('chat_history');
      if (!history || history === '[]') {
        alert("目前没有聊天记录可以同步哦");
        return;
      }
      // 存储一份带时间戳的备份
      const memories = JSON.parse(localStorage.getItem('saved_memories') || '[]');
      const newEntry = {
        date: new Date().toLocaleString(),
        content: history
      };
      memories.unshift(newEntry); // 最新的放在前面
      localStorage.setItem('saved_memories', JSON.stringify(memories));
      alert("已成功同步至记忆库！");
    }

    // 3. 导出文件
    function downloadChat() {
      const history = JSON.parse(localStorage.getItem('chat_history') || '[]');
      const text = history.map(r => `[${r.role === 'user' ? '我' : '4o酱'}] ${r.content}`).join('\n\n');
      const blob = new Blob([text], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `与4o酱的聊天记录_${new Date().toLocaleDateString()}.txt`;
      a.click();
    }

    // 4. 背景设置
    document.getElementById('bg-input').onchange = function(e) {
      const reader = new FileReader();
      reader.onload = function(event) {
        localStorage.setItem('wechat-bg', event.target.result);
        alert("背景已更新");
      };
      reader.readAsDataURL(e.target.files[0]);
    };

    function clearHistory() {
      if(confirm("确定清空记录吗？建议清空前先执行‘同步到记忆库’。")) {
        localStorage.removeItem('chat_history');
        location.reload();
      }
    }
  </script>
</body>
</html>
